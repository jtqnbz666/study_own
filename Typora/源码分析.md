### 网络框架分析

Nginx

~~~shell
master进程负责管理worker进程，包括启动、停止和监控worker进程。
worker进程负责处理实际的请求。

main函数在src/core/nginx.c中
1. bind和listen操作：在main函数的ngx_init_cycle中的ngx_open_listening_sockets可以看到。 # 如果设置了reuseport，并且work进程的数量设置为4，那么master会直接创建(bind+listen)4个listenfd，每个work进程执行了epoll_create后会放其中一个listenfd到自己的epoll中, 如果不设置reuseport那么master进程只会创建一个listenfd，这4个work进程共用同一个listenfd(也就是所有work进程共用一个监听队列，必须配合accept锁来避免惊群)
2. fork操作：main函数中有ngx_master_process_cycle函数，这里面的ngx_start_worker_processes里面的ngx_spawn_process执行fork子进程的操作
3. epoll_create操作：fork操作中ngx_spawn_process传递了一个函数指针ngx_worker_process_cycle，fork执行完后就会执行ngx_worker_process_cycle，进一步看ngx_worker_process_init，再进一步看cycle->modules[i]->init_process(cycle)，这个init_process绑定的是ngx_event_process_init函数，进一步可以看到module->actions.init，这个init函数绑定的是ngx_epoll_init，这里面执行了epoll_create, 然后把fork之前的listenfd放到各个work进程的epoll中，但由于多进程监听同一个listenfd，所以有惊群现象，需要配合nginx实现的accept锁来避免惊群问题。
~~~

